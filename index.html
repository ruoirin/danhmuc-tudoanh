<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Báo cáo Tương tác Danh mục Tự doanh FVTPL</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Cấu trúc ứng dụng: Một SPA kiểu bảng điều khiển với ba chế độ xem tương tác chính có thể truy cập qua các tab: "Tổng quan", "Chi tiết theo Công ty", và "Chi tiết theo Cổ phiếu". Tổng quan cung cấp thông tin chi tiết tổng hợp về thị trường với các biểu đồ tổng quát. Hai chế độ xem còn lại cho phép người dùng xem sâu hơn vào các lát dữ liệu cụ thể bằng cách sử dụng các bộ lọc thả xuống. Cấu trúc theo định hướng tác vụ này (tóm tắt tổng thể -> cụ thể theo công ty -> cụ thể theo cổ phiếu) cung cấp một luồng người dùng logic và trực quan để khám phá dữ liệu từ nhiều góc độ, hiệu quả hơn cho việc phân tích so với một bảng tĩnh duy nhất. -->
    <!-- Lựa chọn trực quan hóa & nội dung: 
        - Các chỉ số chính (KPI): Mục tiêu: Thông báo. Phương pháp: Thẻ HTML được tạo kiểu. Tương tác: Hiển thị tĩnh. Lý do: Cung cấp ngay lập tức các số liệu tóm tắt cấp cao.
        - Tổng giá trị theo Công ty (Biểu đồ thanh): Mục tiêu: So sánh. Phương pháp: Canvas Chart.js. Tương tác: Gợi ý khi di chuột. Lý do: Nhanh chóng xác định tổng giá trị đầu tư của mỗi công ty chứng khoán.
        - Tổng chênh lệch đánh giá theo Công ty (Biểu đồ thanh): Mục tiêu: So sánh. Phương pháp: Canvas Chart.js. Tương tác: Gợi ý khi di chuột. Lý do: Nổi bật những cổ phiếu tăng và giảm lớn nhất để phân tích hiệu suất nhanh chóng.
        - Top/Bottom cổ phiếu có hiệu suất cao nhất (Biểu đồ thanh ngang): Mục tiêu: So sánh. Phương pháp: Canvas Chart.js với màu sắc có điều kiện. Tương tác: Gợi ý khi di chuột. Lý do: Nổi bật những cổ phiếu tăng và giảm lớn nhất để phân tích hiệu suất nhanh chóng.
        - Phân bổ đầu tư theo Công ty (Biểu đồ tròn): Mục tiêu: So sánh/Phân bổ. Phương pháp: Canvas Chart.js. Tương tác: Gợi ý khi di chuột. Lý do: Cho thấy quy mô đầu tư tương đối của từng công ty chứng khoán.
        - Bộ lọc thả xuống & Bảng/Biểu đồ động: Mục tiêu: Tổ chức/Tương tác. Phương pháp: Các phần tử chọn HTML + lọc JS + cập nhật bảng/biểu đồ Chart.js/HTML. Lý do: Cho phép khám phá mạnh mẽ, do người dùng điều khiển các danh mục đầu tư cụ thể của công ty và quyền sở hữu cụ thể của cổ phiếu mà không cần rời khỏi trang.
    -->
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8f7f4;
            color: #3a3a3a;
        }
        .chart-container {
            position: relative;
            width: 100%;
            max-width: 800px;
            margin-left: auto;
            margin-right: auto;
            height: 40vh;
            max-height: 450px;
        }
        .kpi-card {
            background-color: #ffffff;
            border-radius: 0.75rem;
            padding: 1.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -2px rgba(0, 0, 0, 0.05);
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        .kpi-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.07), 0 4px 6px -4px rgba(0, 0, 0, 0.07);
        }
        .tab-btn {
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s, color 0.3s;
            background-color: #e9e7e2;
            color: #5f5f5f;
            border: 2px solid transparent;
        }
        .tab-btn.active {
            background-color: #3a3a3a;
            color: #ffffff;
        }
        select, input {
            background-color: #ffffff;
            border: 1px solid #dcdcdc;
            border-radius: 0.5rem;
        }
        table {
            border-collapse: separate;
            border-spacing: 0;
            border-radius: 0.75rem;
            overflow: hidden;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
        }
        th, td {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid #e5e7eb;
        }
        thead th {
            background-color: #e5e7eb;
            color: #4b5563;
        }
        tbody tr:last-child td {
            border-bottom: none;
        }
        tfoot {
            background-color: #d1d5db;
        }
    </style>
</head>
<body class="antialiased">

    <div class="container mx-auto p-4 sm:p-6 md:p-8">
        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-800">Bảng điều khiển Danh mục Tự doanh FVTPL</h1>
            <p class="text-lg text-gray-500 mt-2">Tổng hợp và phân tích danh mục tại ngày 14/08/2025</p>
        </header>

        <main>
            <!-- KPI Section -->
            <div id="kpi-section" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                <div class="kpi-card">
                    <h3 class="text-md font-semibold text-gray-500">Tổng Giá trị Hiện tại</h3>
                    <p id="total-value" class="text-2xl font-bold text-green-600 mt-2">0</p>
                </div>
                <div class="kpi-card">
                    <h3 class="text-md font-semibold text-gray-500">Tổng Chênh lệch Đánh giá</h3>
                    <p id="total-diff" class="text-2xl font-bold text-blue-600 mt-2">0</p>
                </div>
                <div class="kpi-card">
                    <h3 class="text-md font-semibold text-gray-500">Số Công ty Phân tích</h3>
                    <p id="company-count" class="text-2xl font-bold text-gray-700 mt-2">0</p>
                </div>
                <div class="kpi-card">
                    <h3 class="text-md font-semibold text-gray-500">Số Cổ phiếu nắm giữ</h3>
                    <p id="stock-count" class="text-2xl font-bold text-gray-700 mt-2">0</p>
                </div>
            </div>

            <!-- Main Tabbed Content -->
            <div class="bg-white rounded-xl shadow-lg p-4 sm:p-6 mb-8">
                <div class="flex flex-wrap justify-center gap-2 mb-6 border-b pb-4">
                    <button id="overview-tab" class="tab-btn active" data-tab="overview">Tổng quan</button>
                    <button id="company-tab" class="tab-btn" data-tab="company">Chi tiết theo Công ty</button>
                    <button id="stock-tab" class="tab-btn" data-tab="stock">Chi tiết theo Cổ phiếu</button>
                </div>

                <!-- Overview Tab Content -->
                <div id="overview-content" class="tab-content">
                    <p class="text-center text-gray-600 mb-8 max-w-3xl mx-auto">
                        Phân tích tổng quan cung cấp cái nhìn toàn cảnh về danh mục đầu tư của các công ty chứng khoán. Các biểu đồ dưới đây giúp bạn dễ dàng so sánh tổng giá trị và chênh lệch đánh giá của từng công ty.
                    </p>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <div class="bg-gray-50 p-6 rounded-lg">
                            <h3 class="text-xl font-semibold text-center mb-4">Tổng Giá trị hiện tại của Danh mục tự doanh theo Công ty</h3>
                            <div class="chart-container"><canvas id="companyTotalValueChart"></canvas></div>
                        </div>
                        <div class="bg-gray-50 p-6 rounded-lg">
                            <h3 class="text-xl font-semibold text-center mb-4">Tổng Chênh lệch đánh giá của Danh mục tự doanh theo Công ty</h3>
                            <div class="chart-container"><canvas id="companyTotalDiffChart"></canvas></div>
                        </div>
                        <div class="lg:col-span-2 bg-gray-50 p-6 rounded-lg">
                            <h3 class="text-xl font-semibold text-center mb-4">Top 10 Cổ phiếu Lãi/Lỗ Cao nhất</h3>
                            <p class="text-center text-sm text-gray-500 mb-4">Dựa trên chênh lệch đánh giá tài sản</p>
                            <div class="chart-container"><canvas id="topPerformanceChart"></canvas></div>
                        </div>
                        <div class="lg:col-span-2 bg-gray-50 p-6 rounded-lg">
                            <h3 class="text-xl font-semibold text-center mb-4">Phân bổ Đầu tư theo Công ty</h3>
                            <div class="chart-container"><canvas id="investmentByCompanyChart"></canvas></div>
                        </div>
                    </div>
                </div>

                <!-- By Company Tab Content -->
                <div id="company-content" class="tab-content hidden">
                    <p class="text-center text-gray-600 mb-6 max-w-3xl mx-auto">
                        Chọn một công ty chứng khoán từ danh sách để xem chi tiết danh mục đầu tư, bao gồm tỷ trọng các cổ phiếu và bảng phân tích cụ thể.
                    </p>
                    <div class="flex justify-center mb-6">
                        <select id="company-select" class="p-3 rounded-lg border border-gray-300 shadow-sm w-full max-w-md">
                            <option value="">-- Chọn Công ty --</option>
                        </select>
                    </div>
                    <div id="company-details" class="hidden">
                        <div class="grid grid-cols-1 gap-8">
                            <div class="bg-gray-50 p-6 rounded-lg">
                                <h3 id="company-chart-title" class="text-xl font-semibold text-center mb-4">Phân bổ Danh mục</h3>
                                <div class="chart-container"><canvas id="companyPortfolioChart"></canvas></div>
                            </div>
                            <div class="bg-gray-50 p-6 rounded-lg overflow-x-auto">
                                <h3 id="company-table-title" class="text-xl font-semibold text-center mb-4">Bảng Chi tiết</h3>
                                <table class="w-full text-left rounded-lg overflow-hidden">
                                    <thead class="bg-gray-200">
                                        <tr>
                                            <th class="p-3">Mã CK</th>
                                            <th class="p-3 text-right">Giá cổ phiếu 30/06</th>
                                            <th class="p-3 text-right">Giá trị 30/06</th>
                                            <th class="p-3 text-right">Giá cổ phiếu hiện tại</th>
                                            <th class="p-3 text-right">Giá trị Hiện tại</th>
                                            <th class="p-3 text-right">Chênh lệch</th>
                                            <th class="p-3 text-right">% Tăng/giảm</th>
                                        </tr>
                                    </thead>
                                    <tbody id="company-table-body" class="bg-white"></tbody>
                                    <tfoot id="company-table-footer" class="bg-gray-200 font-bold"></tfoot>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- By Stock Tab Content -->
                <div id="stock-content" class="tab-content hidden">
                    <p class="text-center text-gray-600 mb-6 max-w-3xl mx-auto">
                        Chọn một mã cổ phiếu để xem các công ty chứng khoán nào đang nắm giữ và giá trị đầu tư của họ vào mã đó.
                    </p>
                    <div class="flex justify-center mb-6">
                        <select id="stock-select" class="p-3 rounded-lg border border-gray-300 shadow-sm w-full max-w-md">
                            <option value="">-- Chọn Cổ phiếu --</option>
                        </select>
                    </div>
                    <div id="stock-details" class="hidden">
                        <div class="grid grid-cols-1 gap-8">
                            <div class="bg-gray-50 p-6 rounded-lg">
                                <h3 id="stock-chart-title" class="text-xl font-semibold text-center mb-4">Phân bổ nắm giữ theo Công ty</h3>
                                <div class="chart-container"><canvas id="stockHoldersChart"></canvas></div>
                            </div>
                            <div class="bg-gray-50 p-6 rounded-lg overflow-x-auto">
                                <h3 id="stock-table-title" class="text-xl font-semibold text-center mb-4">Bảng Chi tiết</h3>
                                <table class="w-full text-left rounded-lg overflow-hidden">
                                    <thead class="bg-gray-200">
                                        <tr>
                                            <th class="p-3">Công ty</th>
                                            <th class="p-3 text-right">Giá cổ phiếu 30/06</th>
                                            <th class="p-3 text-right">Giá trị 30/06</th>
                                            <th class="p-3 text-right">Giá cổ phiếu hiện tại</th>
                                            <th class="p-3 text-right">Giá trị Hiện tại</th>
                                            <th class="p-3 text-right">Chênh lệch</th>
                                            <th class="p-3 text-right">% Tăng/giảm</th>
                                        </tr>
                                    </thead>
                                    <tbody id="stock-table-body" class="bg-white"></tbody>
                                    <tfoot id="stock-table-footer" class="bg-gray-200 font-bold"></tfoot>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Dữ liệu giả lập với giá cổ phiếu và giá trị 30/06 cập nhật từ hình ảnh bạn cung cấp
            const portfolioData = [
                { stock: "ACB", company: "SSI", shares: 789500, price_30_06: 21300, price_current: 26550, initialValue: 16807350000 },
                { stock: "ACB", company: "SSI (phòng ngừa)", shares: 5074667, price_30_06: 21300, price_current: 26550, initialValue: 108095400000 },
                { stock: "ACB", company: "Rồng Việt (VDS)", shares: 5603963, price_30_06: 21300, price_current: 26550, initialValue: 119364400000 },
                { stock: "EIB", company: "Vietinbank (CTS)", shares: 14852500, price_30_06: 22900, price_current: 29550, initialValue: 282197500000 },
                { stock: "FPT", company: "HSC", shares: 7425620, price_30_06: 102800, price_current: 102900, initialValue: 763428800000 },
                { stock: "FPT", company: "SHS", shares: 2108215, price_30_06: 102800, price_current: 102900, initialValue: 216709800000 },
                { stock: "FPT", company: "Agribank (AGR)", shares: 73875, price_30_06: 102800, price_current: 102900, initialValue: 7594500000 },
                { stock: "GEX", company: "SHS", shares: 17069592, price_30_06: 37400, price_current: 56900, initialValue: 638400000000 },
                { stock: "GEX", company: "Vietinbank (CTS)", shares: 313696, price_30_06: 37400, price_current: 56900, initialValue: 7842406000 },
                { stock: "GMD", company: "HSC", shares: 508114, price_30_06: 70500, price_current: 75200, initialValue: 35820000000 },
                { stock: "HPG", company: "HSC", shares: 8930211, price_30_06: 22700, price_current: 28200, initialValue: 202905000000 },
                { stock: "HPG", company: "SSI", shares: 1192217, price_30_06: 22700, price_current: 28200, initialValue: 27050000000 },
                { stock: "HPG", company: "SSI (phòng ngừa)", shares: 4410831, price_30_06: 22700, price_current: 28200, initialValue: 100140000000 },
                { stock: "HPG", company: "TCI", shares: 403903, price_30_06: 22700, price_current: 28200, initialValue: 9168000000 },
                { stock: "HPG", company: "BSI", shares: 3935746, price_30_06: 22700, price_current: 28200, initialValue: 89320000000 },
                { stock: "HPG", company: "SHS", shares: 3381517, price_30_06: 22700, price_current: 28200, initialValue: 76770000000 },
                { stock: "HPG", company: "Agribank (AGR)", shares: 587069, price_30_06: 22700, price_current: 28200, initialValue: 13329000000 },
                { stock: "HSG", company: "VNDirect (VND)", shares: 18537508, price_30_06: 16600, price_current: 19550, initialValue: 307722600000 },
                { stock: "KBC", company: "Rồng Việt (VDS)", shares: 14576300, price_30_06: 26800, price_current: 33050, initialValue: 390055000000 },
                { stock: "MBB", company: "HSC", shares: 6465548, price_30_06: 19500, price_current: 28500, initialValue: 126078000000 },
                { stock: "MSH", company: "FPT (FTS)", shares: 6305375, price_30_06: 37300, price_current: 37800, initialValue: 235250000000 },
                { stock: "MSN", company: "SSI", shares: 519552, price_30_06: 76800, price_current: 84300, initialValue: 39900000000 },
                { stock: "MWG", company: "HSC", shares: 7887136, price_30_06: 58900, price_current: 70400, initialValue: 464520000000 },
                { stock: "MWG", company: "Rồng Việt (VDS)", shares: 2856335, price_30_06: 58900, price_current: 70400, initialValue: 168250000000 },
                { stock: "NAF", company: "Agribank (AGR)", shares: 811667, price_30_06: 25400, price_current: 28650, initialValue: 20610000000 },
                { stock: "PET", company: "Vietinbank (CTS)", shares: 3136100, price_30_06: 24100, price_current: 36050, initialValue: 87810760000 },
                { stock: "SSI", company: "HSC", shares: 991592, price_30_06: 24700, price_current: 36700, initialValue: 24500000000 },
                { stock: "SSI", company: "Agribank (AGR)", shares: 636212, price_30_06: 24700, price_current: 36700, initialValue: 15720000000 },
                { stock: "STB", company: "SSI", shares: 4897835, price_30_06: 45700, price_current: 54100, initialValue: 223900000000 },
                { stock: "TCB", company: "HSC", shares: 30497337, price_30_06: 34200, price_current: 38000, initialValue: 1042910000000 },
                { stock: "TCB", company: "TCI", shares: 256500, price_30_06: 34200, price_current: 38000, initialValue: 8772000000 },
                { stock: "TCB", company: "SHS", shares: 4446000, price_30_06: 34200, price_current: 38000, initialValue: 152140000000 },
                { stock: "VHC", company: "BSI", shares: 925350, price_30_06: 59700, price_current: 59900, initialValue: 55260000000 },
                { stock: "VHM", company: "DNSE", shares: 898486, price_30_06: 76700, price_current: 94100, initialValue: 68925000000 },
                { stock: "VHM", company: "SSI", shares: 3935477, price_30_06: 76700, price_current: 94100, initialValue: 301800000000 },
                { stock: "VIB", company: "DNSE", shares: 2928588, price_30_06: 16100, price_current: 20450, initialValue: 47160000000 },
                { stock: "VIB", company: "HSC", shares: 3235879, price_30_06: 16100, price_current: 20450, initialValue: 52080000000 },
                { stock: "VIB", company: "TCI", shares: 658800, price_30_06: 16100, price_current: 20450, initialValue: 10617000000 },
                { stock: "VND", company: "Agribank (AGR)", shares: 917333, price_30_06: 17200, price_current: 24650, initialValue: 15778000000 },
                { stock: "VPB", company: "HSC", shares: 3329630, price_30_06: 18500, price_current: 31500, initialValue: 61608000000 },
                { stock: "VPB", company: "SSI", shares: 24759063, price_30_06: 18500, price_current: 31500, initialValue: 458042000000 },
                { stock: "VPB", company: "VNDirect (VND)", shares: 23555900, price_30_06: 18500, price_current: 31500, initialValue: 435784000000 },
                { stock: "VPB", company: "BSI", shares: 4088516, price_30_06: 18500, price_current: 31500, initialValue: 75630000000 },
                { stock: "VPB", company: "SHS", shares: 14376812, price_30_06: 18500, price_current: 31500, initialValue: 266000000000 },
                { stock: "VPB", company: "Vietinbank (CTS)", shares: 3218630, price_30_06: 18500, price_current: 31500, initialValue: 64372600000 },
                { stock: "VSC", company: "Vietinbank (CTS)", shares: 4315945, price_30_06: 16050, price_current: 33350, initialValue: 172637812500 },
                { stock: "VIX", company: "Vietinbank (CTS)", shares: 5274675, price_30_06: 12800, price_current: 34350, initialValue: 105493500000 },
                { stock: "EIB", company: "VIX", shares: 88000000, price_30_06: 22900, price_current: 29550, initialValue: 2015200000000 },
                { stock: "VSC", company: "VIX", shares: 27335156, price_30_06: 16050, price_current: 33350, initialValue: 438698000000 },
                { stock: "HAH", company: "VIX", shares: 16715000, price_30_06: 51200, price_current: 61400, initialValue: 855550000000 },
                { stock: "GEX", company: "VIX", shares: 34811726, price_30_06: 37400, price_current: 56900, initialValue: 1301900000000 },
                { stock: "BSR", company: "VIX", shares: 35196904, price_30_06: 17900, price_current: 24100, initialValue: 629900000000 },
                { stock: "PC1", company: "VIX", shares: 15111000, price_30_06: 21900, price_current: 27700, initialValue: 330950000000 },
                { stock: "SHS", company: "VIX", shares: 27276333, price_30_06: 12900, price_current: 25200, initialValue: 351850000000 },
                { stock: "GEE", company: "VIX", shares: 13349649, price_30_06: 97400, price_current: 125000, initialValue: 1300000000000 },
                { stock: "HNG", company: "Vietinbank (CTS)", shares: 6262834, price_30_06: 5900, price_current: 6700, initialValue: 36950720000 },
                { stock: "TLP", company: "Vietinbank (CTS)", shares: 2126697, price_30_06: 6900, price_current: 7200, initialValue: 14674211100 },
                { stock: "HSG", company: "Rồng Việt (VDS)", shares: 4066654, price_30_06: 16600, price_current: 19550, initialValue: 67500000000 }
            ];

            // Hàm tính toán các giá trị dựa trên dữ liệu thô
            const calculatePortfolioData = (data) => {
                return data.map(item => ({
                    ...item,
                    initialValue: item.initialValue, // Giá trị đã có sẵn từ dữ liệu
                    currentValue: (item.initialValue / item.price_30_06) * item.price_current,
                    diff: ((item.initialValue / item.price_30_06) * item.price_current) - item.initialValue,
                    change: (((item.initialValue / item.price_30_06) * item.price_current - item.initialValue) / item.initialValue) * 100
                }));
            };

            const calculatedData = calculatePortfolioData(portfolioData);

            // Lấy danh sách công ty và cổ phiếu duy nhất
            const uniqueCompanies = [...new Set(calculatedData.map(item => item.company.replace(/ \(.*/, '')))].sort();
            const uniqueStocks = [...new Set(calculatedData.map(item => item.stock))].sort();

            const companySelect = document.getElementById('company-select');
            const stockSelect = document.getElementById('stock-select');

            // Điền dữ liệu vào dropdown Công ty
            uniqueCompanies.forEach(company => {
                const option = document.createElement('option');
                option.value = company;
                option.textContent = company;
                companySelect.appendChild(option);
            });

            // Điền dữ liệu vào dropdown Cổ phiếu
            uniqueStocks.forEach(stock => {
                const option = document.createElement('option');
                option.value = stock;
                option.textContent = stock;
                stockSelect.appendChild(option);
            });

            // Hàm định dạng tiền tệ
            const formatCurrency = (value) => {
                const absoluteValue = Math.abs(value);
                let formattedValue;
                let unit = '';

                if (absoluteValue >= 1e12) {
                    formattedValue = (value / 1e12).toFixed(2);
                    unit = ' nghìn tỷ';
                } else if (absoluteValue >= 1e9) {
                    formattedValue = (value / 1e9).toFixed(2);
                    unit = ' tỷ';
                } else if (absoluteValue >= 1e6) {
                    formattedValue = (value / 1e6).toFixed(2);
                    unit = ' triệu';
                } else {
                    return new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(value);
                }

                const parts = formattedValue.toString().split('.');
                parts[0] = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, ",");
                const formattedNumber = parts.join('.');

                return (value < 0 ? '-' : '') + formattedNumber + unit + ' VND';
            };

            // Hàm định dạng giá cổ phiếu
            const formatStockPrice = (value) => {
                return new Intl.NumberFormat('vi-VN').format(value);
            };

            const chartInstances = {};

            // Hàm tạo/cập nhật biểu đồ
            function renderChart(canvasId, config) {
                if (chartInstances[canvasId]) {
                    chartInstances[canvasId].destroy();
                }
                const ctx = document.getElementById(canvasId);
                if (ctx) {
                    chartInstances[canvasId] = new Chart(ctx.getContext('2d'), config);
                }
            }

            // Cập nhật các chỉ số KPI
            function setupKPIs() {
                const totalValue = calculatedData.reduce((sum, item) => sum + item.currentValue, 0);
                const totalDiff = calculatedData.reduce((sum, item) => sum + item.diff, 0);
                document.getElementById('total-value').textContent = formatCurrency(totalValue);
                document.getElementById('total-diff').textContent = formatCurrency(totalDiff);
                document.getElementById('company-count').textContent = uniqueCompanies.length;
                document.getElementById('stock-count').textContent = uniqueStocks.length;
            }

            // Cập nhật nội dung tab Tổng quan
            function setupOverview() {
                // Biểu đồ giá trị theo công ty
                const companyTotals = calculatedData.reduce((acc, item) => {
                    const companyName = item.company.replace(/ \(.*/, '');
                    acc[companyName] = (acc[companyName] || 0) + item.currentValue;
                    return acc;
                }, {});

                renderChart('companyTotalValueChart', {
                    type: 'bar',
                    data: {
                        labels: Object.keys(companyTotals),
                        datasets: [{
                            label: 'Tổng Giá trị Hiện tại',
                            data: Object.values(companyTotals),
                            backgroundColor: '#60a5fa',
                            borderColor: '#3b82f6',
                            borderWidth: 1
                        }]
                    },
                    options: { 
                        maintainAspectRatio: false, 
                        responsive: true, 
                        plugins: { legend: { display: false } },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) {
                                        return formatCurrency(value);
                                    }
                                }
                            }
                        }
                    }
                });
                
                // Biểu đồ chênh lệch theo công ty
                const companyDiffs = calculatedData.reduce((acc, item) => {
                    const companyName = item.company.replace(/ \(.*/, '');
                    acc[companyName] = (acc[companyName] || 0) + item.diff;
                    return acc;
                }, {});

                renderChart('companyTotalDiffChart', {
                    type: 'bar',
                    data: {
                        labels: Object.keys(companyDiffs),
                        datasets: [{
                            label: 'Tổng Chênh lệch Đánh giá',
                            data: Object.values(companyDiffs),
                            backgroundColor: Object.values(companyDiffs).map(diff => diff >= 0 ? 'rgba(52, 211, 153, 0.7)' : 'rgba(248, 113, 113, 0.7)'),
                            borderColor: Object.values(companyDiffs).map(diff => diff >= 0 ? '#10b981' : '#ef4444'),
                            borderWidth: 1
                        }]
                    },
                    options: { 
                        maintainAspectRatio: false, 
                        responsive: true, 
                        plugins: { legend: { display: false } },
                        scales: {
                            y: {
                                beginAtZero: false,
                                ticks: {
                                    callback: function(value) {
                                        return formatCurrency(value);
                                    }
                                }
                            }
                        }
                    }
                });

                // Biểu đồ top cổ phiếu
                const performanceByStock = calculatedData.reduce((acc, item) => {
                    acc[item.stock] = (acc[item.stock] || 0) + item.diff;
                    return acc;
                }, {});

                const sortedPerformance = Object.entries(performanceByStock).sort(([, a], [, b]) => b - a);
                const topPerformers = [...sortedPerformance.slice(0, 5), ...sortedPerformance.slice(-5)].sort(([, a], [, b]) => b - a);
                const performanceLabels = topPerformers.map(item => item[0]);
                const performanceData = topPerformers.map(item => item[1]);

                renderChart('topPerformanceChart', {
                    type: 'bar',
                    data: {
                        labels: performanceLabels,
                        datasets: [{
                            label: 'Chênh lệch',
                            data: performanceData,
                            backgroundColor: performanceData.map(item => item > 0 ? 'rgba(52, 211, 153, 0.7)' : 'rgba(248, 113, 113, 0.7)'),
                            borderColor: performanceData.map(item => item > 0 ? '#10b981' : '#ef4444'),
                            borderWidth: 1
                        }]
                    },
                    options: { 
                        indexAxis: 'y', 
                        maintainAspectRatio: false, 
                        responsive: true, 
                        plugins: { legend: { display: false } },
                        scales: {
                            x: {
                                beginAtZero: false,
                                ticks: {
                                    callback: function(value) {
                                        return formatCurrency(value);
                                    }
                                }
                            }
                        }
                    }
                });
                
                // Biểu đồ tròn phân bổ
                renderChart('investmentByCompanyChart', {
                    type: 'doughnut',
                    data: {
                        labels: Object.keys(companyTotals),
                        datasets: [{
                            data: Object.values(companyTotals),
                            backgroundColor: ['#34d399', '#f87171', '#fbbf24', '#a78bfa', '#60a5fa', '#fb923c', '#f472b6', '#2dd4bf'],
                        }]
                    },
                    options: { maintainAspectRatio: false, responsive: true }
                });
            }

            // Xử lý sự kiện khi thay đổi Công ty
            function handleCompanyChange() {
                const selectedCompany = companySelect.value;
                const detailsDiv = document.getElementById('company-details');
                if (!selectedCompany) {
                    detailsDiv.classList.add('hidden');
                    return;
                }
                detailsDiv.classList.remove('hidden');

                const companyData = calculatedData.filter(item => item.company.startsWith(selectedCompany));
                
                document.getElementById('company-chart-title').textContent = `Phân bổ Danh mục của ${selectedCompany}`;
                document.getElementById('company-table-title').textContent = `Bảng Chi tiết của ${selectedCompany}`;

                // Biểu đồ tròn phân bổ danh mục theo cổ phiếu
                renderChart('companyPortfolioChart', {
                    type: 'pie',
                    data: {
                        labels: companyData.map(d => d.stock),
                        datasets: [{
                            data: companyData.map(d => d.currentValue),
                            backgroundColor: ['#34d399', '#f87171', '#fbbf24', '#a78bfa', '#60a5fa', '#fb923c', '#f472b6', '#2dd4bf'],
                        }]
                    },
                    options: { maintainAspectRatio: false, responsive: true }
                });

                // Cập nhật bảng chi tiết
                const tableBody = document.getElementById('company-table-body');
                tableBody.innerHTML = '';
                let totalCurrentValue = 0;
                let totalInitialValue = 0;
                let totalDiff = 0;

                companyData.sort((a,b) => b.currentValue - a.currentValue).forEach(item => {
                    totalCurrentValue += item.currentValue;
                    totalInitialValue += item.initialValue;
                    totalDiff += item.diff;
                    const row = `<tr class="border-b border-gray-200 hover:bg-gray-100">
                        <td class="p-3 font-semibold">${item.stock}</td>
                        <td class="p-3 text-right">${formatStockPrice(item.price_30_06)} VND</td>
                        <td class="p-3 text-right">${formatCurrency(item.initialValue)}</td>
                        <td class="p-3 text-right">${formatStockPrice(item.price_current)} VND</td>
                        <td class="p-3 text-right">${formatCurrency(item.currentValue)}</td>
                        <td class="p-3 text-right ${item.diff >= 0 ? 'text-green-600' : 'text-red-600'}">${formatCurrency(item.diff)}</td>
                        <td class="p-3 text-right font-medium ${item.change >= 0 ? 'text-green-600' : 'text-red-600'}">${item.change.toFixed(2)}%</td>
                    </tr>`;
                    tableBody.innerHTML += row;
                });
                
                const tableFooter = document.getElementById('company-table-footer');
                tableFooter.innerHTML = `
                    <tr>
                        <td class="p-3">Tổng cộng</td>
                        <td class="p-3"></td>
                        <td class="p-3 text-right">${formatCurrency(totalInitialValue)}</td>
                        <td class="p-3"></td>
                        <td class="p-3 text-right">${formatCurrency(totalCurrentValue)}</td>
                        <td class="p-3 text-right">${formatCurrency(totalDiff)}</td>
                        <td class="p-3 text-right"></td>
                    </tr>
                `;
            }

            // Xử lý sự kiện khi thay đổi Cổ phiếu
            function handleStockChange() {
                const selectedStock = stockSelect.value;
                const detailsDiv = document.getElementById('stock-details');
                if (!selectedStock) {
                    detailsDiv.classList.add('hidden');
                    return;
                }
                detailsDiv.classList.remove('hidden');

                const stockData = calculatedData.filter(item => item.stock === selectedStock);
                
                document.getElementById('stock-chart-title').textContent = `Phân bổ nắm giữ ${selectedStock} theo Công ty`;
                document.getElementById('stock-table-title').textContent = `Bảng Chi tiết nắm giữ ${selectedStock}`;

                // Biểu đồ cột phân bổ nắm giữ theo công ty
                renderChart('stockHoldersChart', {
                    type: 'bar',
                    data: {
                        labels: stockData.map(d => d.company),
                        datasets: [{
                            label: `Giá trị nắm giữ ${selectedStock}`,
                            data: stockData.map(d => d.currentValue),
                            backgroundColor: '#a78bfa',
                            borderColor: '#8b5cf6',
                            borderWidth: 1
                        }]
                    },
                    options: { 
                        maintainAspectRatio: false, 
                        responsive: true, 
                        plugins: { legend: { display: false } },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) {
                                        return formatCurrency(value);
                                    }
                                }
                            }
                        }
                    }
                });

                // Cập nhật bảng chi tiết
                const tableBody = document.getElementById('stock-table-body');
                tableBody.innerHTML = '';
                let totalCurrentValue = 0;
                let totalInitialValue = 0;
                let totalDiff = 0;

                stockData.sort((a,b) => b.currentValue - a.currentValue).forEach(item => {
                    totalCurrentValue += item.currentValue;
                    totalInitialValue += item.initialValue;
                    totalDiff += item.diff;
                    const row = `<tr class="border-b border-gray-200 hover:bg-gray-100">
                        <td class="p-3 font-semibold">${item.company}</td>
                        <td class="p-3 text-right">${formatStockPrice(item.price_30_06)} VND</td>
                        <td class="p-3 text-right">${formatCurrency(item.initialValue)}</td>
                        <td class="p-3 text-right">${formatStockPrice(item.price_current)} VND</td>
                        <td class="p-3 text-right">${formatCurrency(item.currentValue)}</td>
                        <td class="p-3 text-right ${item.diff >= 0 ? 'text-green-600' : 'text-red-600'}">${formatCurrency(item.diff)}</td>
                        <td class="p-3 text-right font-medium ${item.change >= 0 ? 'text-green-600' : 'text-red-600'}">${item.change.toFixed(2)}%</td>
                    </tr>`;
                    tableBody.innerHTML += row;
                });
                const tableFooter = document.getElementById('stock-table-footer');
                tableFooter.innerHTML = `
                    <tr>
                        <td class="p-3">Tổng cộng</td>
                        <td class="p-3"></td>
                        <td class="p-3 text-right">${formatCurrency(totalInitialValue)}</td>
                        <td class="p-3"></td>
                        <td class="p-3 text-right">${formatCurrency(totalCurrentValue)}</td>
                        <td class="p-3 text-right">${formatCurrency(totalDiff)}</td>
                        <td class="p-3 text-right"></td>
                    </tr>
                `;
            }

            // Xử lý chuyển đổi giữa các tab
            document.querySelectorAll('.tab-btn').forEach(button => {
                button.addEventListener('click', () => {
                    // Loại bỏ trạng thái 'active' khỏi tất cả các nút tab
                    document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
                    // Thêm trạng thái 'active' vào nút được click
                    button.classList.add('active');
                    // Ẩn tất cả nội dung tab
                    document.querySelectorAll('.tab-content').forEach(content => content.classList.add('hidden'));
                    // Hiển thị nội dung của tab được chọn
                    const selectedTabId = button.dataset.tab;
                    document.getElementById(`${selectedTabId}-content`).classList.remove('hidden');

                    // Gọi lại hàm render biểu đồ cho tab Tổng quan khi chuyển về
                    if (selectedTabId === 'overview') {
                        setupOverview();
                    }
                });
            });

            // Lắng nghe sự kiện thay đổi của dropdown
            companySelect.addEventListener('change', handleCompanyChange);
            stockSelect.addEventListener('change', handleStockChange);

            // Khởi tạo trang web lần đầu
            setupKPIs();
            setupOverview();
        });
    </script>
</body>
</html>
